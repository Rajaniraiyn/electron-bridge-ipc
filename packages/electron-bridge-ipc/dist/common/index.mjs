var g=class{_isDisposed=!1;_toDispose=new Set;dispose(){this._isDisposed||(this._isDisposed=!0,this.clear())}clear(){if(this._toDispose.size!==0)try{k(this._toDispose)}finally{this._toDispose.clear()}}add(n){if(!n)return n;if(n===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(n),n}},L=class{_store=new g;static None=Object.freeze({dispose(){}});dispose(){this._store.dispose()}_register(n){if(n===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(n)}};function k(i){if(i&&Symbol.iterator in i){let n=[];for(let t of i)if(t)try{t.dispose()}catch(r){n.push(r)}if(n.length===1)throw n[0];if(n.length>1)throw new Error("Encountered errors while disposing of store");return Array.isArray(i)?[]:i}else if(i&&"dispose"in i)return i.dispose(),i}function G(...i){return B(()=>k(i))}function B(i){return{dispose:i}}var H=0,v=class{constructor(n){this.value=n}stack;id=H++},w=class{i=-1;end=0;current;value;enqueue(n,t,r){this.i=0,this.end=r,this.current=n,this.value=t}reset(){this.i=this.end,this.current=void 0,this.value=void 0}};function M(i,n){return Array.isArray(n)?n.push(i):n&&n.add(i),i}var A=class{_listeners;_deliveryQueue;_disposed;_options;_event;_size=0;constructor(n){this._options=n,this._deliveryQueue=this._options?.deliveryQueue}_deliver(n,t){n&&n.value(t)}_deliverQueue(n){let t=n.current._listeners;for(;n.i<n.end;)this._deliver(t[n.i++],n.value);n.reset()}fire(n){if(this._deliveryQueue?.current&&this._deliverQueue(this._deliveryQueue),this._listeners)if(this._listeners instanceof v)this._deliver(this._listeners,n);else{let t=this._deliveryQueue;t.enqueue(this,n,this._listeners.length),this._deliverQueue(t)}}get event(){return this._event=(n,t,r)=>{if(this._disposed)return L.None;t&&(n=n.bind(t));let b=new v(n);this._listeners?this._listeners instanceof v?(this._deliveryQueue??=new w,this._listeners=[this._listeners,b]):this._listeners.push(b):(this._options?.onWillAddFirstListener?.(this),this._listeners=b,this._options?.onDidAddFirstListener?.(this)),this._size++;let _=B(()=>{this._removeListener(b)});return r instanceof g?r.add(_):Array.isArray(r)&&r.push(_),_},this._event}_removeListener(n){if(this._options?.onWillRemoveListener?.(this),!this._listeners)return;if(this._size===1){this._listeners=void 0,this._options?.onDidRemoveLastListener?.(this),this._size=0;return}let t=this._listeners,r=t.indexOf(n);if(r===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,t[r]=void 0;let b=this._deliveryQueue.current===this,_=0;for(let c=0;c<t.length;c++)t[c]?t[_++]=t[c]:b&&(this._deliveryQueue.end--,_<this._deliveryQueue.i&&this._deliveryQueue.i--);t.length=_}dispose(){this._disposed||(this._disposed=!0,this._deliveryQueue?.current===this&&this._deliveryQueue.reset(),this._listeners&&(this._listeners=void 0,this._size=0),this._options?.onDidRemoveLastListener?.())}};var y;(x=>{function i(u,s=!1,E=[],l){let e=E.slice(),f=u(D=>{e?e.push(D):U.fire(D)});l&&l.add(f);let o=()=>{e?.forEach(D=>U.fire(D)),e=null},U=new A({onWillAddFirstListener(){f||(f=u(D=>U.fire(D)),l&&l.add(f))},onDidAddFirstListener(){e&&(s?setTimeout(o):o())},onDidRemoveLastListener(){f&&f.dispose(),f=null}});return l&&l.add(U),U.event}x.buffer=i,x.None=()=>L.None;function t(u,s){let E,l={onWillAddFirstListener(){E=u(e.fire,e)},onDidRemoveLastListener(){E?.dispose()}},e=new A(l);return s?.add(e),e.event}function r(u){return u}x.signal=r;function b(u,s,E){return t((l,e=null,f)=>u(o=>s(o)&&l.call(e,o),null,f),E)}x.filter=b;function _(...u){return(s,E=null,l)=>{let e=G(...u.map(f=>f(o=>s.call(E,o))));return M(e,l)}}x.any=_;function c(u,s,E){return t((l,e=null,f)=>u(o=>l.call(e,s(o)),null,f),E)}x.map=c;function m(u){return(s,E=null,l)=>{let e=!1,f=u(o=>{if(!e)return f?f.dispose():e=!0,s.call(E,o)},null,l);return e&&f.dispose(),f}}x.once=m;function p(u){return new Promise(s=>m(u)(s))}x.toPromise=p;function I(u,s,E=l=>l){let l=(...U)=>o.fire(E(...U)),e=()=>u.on(s,l),f=()=>u.removeListener(s,l),o=new A({onWillAddFirstListener:e,onDidRemoveLastListener:f});return o.event}x.fromNodeEventEmitter=I})(y||={});var O=typeof Buffer<"u",R=class i{buffer;byteLength;constructor(n){this.buffer=n,this.byteLength=this.buffer.byteLength}static wrap(n){return O&&!Buffer.isBuffer(n)&&(n=Buffer.from(n.buffer,n.byteOffset,n.byteLength)),new i(n)}writeUInt8(n,t){W(this.buffer,n,t)}readUInt8(n){return K(this.buffer,n)}static alloc(n){return O?new i(Buffer.allocUnsafe(n)):new i(new Uint8Array(n))}static concat(n,t){if(typeof t>"u"){t=0;for(let _=0,c=n.length;_<c;_++)t+=n[_].byteLength}let r=i.alloc(t),b=0;for(let _=0,c=n.length;_<c;_++){let m=n[_];r.set(m,b),b+=m.byteLength}return r}set(n,t){if(n instanceof i)this.buffer.set(n.buffer,t);else if(n instanceof Uint8Array)this.buffer.set(n,t);else if(n instanceof ArrayBuffer)this.buffer.set(new Uint8Array(n),t);else if(ArrayBuffer.isView(n))this.buffer.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t);else throw new TypeError("Unknown argument 'array'")}slice(n,t){return new i(this.buffer.subarray(n,t))}static fromString(n,t){return!(t?.dontUseNodeBuffer||!1)&&O?new i(Buffer.from(n)):(F||(F=new TextEncoder),new i(F.encode(n)))}toString(){return O?this.buffer.toString():(S||(S=new TextDecoder),S.decode(this.buffer))}},F,S;var Y={Undefined:T(0),String:T(1),Buffer:T(2),ELBuffer:T(3),Array:T(4),Object:T(5),Uint:T(6)};function T(i){let n=R.alloc(1);return n.writeUInt8(i,0),n}var J=T(0);function W(i,n,t){i[t]=n}function K(i,n){return i[n]}function P(i){return i>=65&&i<=90}function N(i,n=0){if(!i||n>200)return i;if(typeof i=="object"){switch(i.$mid){case 2:return new RegExp(i.source,i.flags);case 17:return new Date(i.source)}if(i instanceof R||i instanceof Uint8Array)return i;if(Array.isArray(i))for(let t=0;t<i.length;++t)i[t]=N(i[t],n+1);else for(let t in i)Object.hasOwnProperty.call(i,t)&&(i[t]=N(i[t],n+1))}return i}var Q;(b=>{function i(_){return _.startsWith("onDynamic")&&P(_.charCodeAt(9))}function n(_){return _[0]==="o"&&_[1]==="n"&&P(_.charCodeAt(2))}function t(_,c,m){let p=_,I=m&&m.disableMarshalling,x=new Map;for(let u in p)n(u)&&x.set(u,y.buffer(p[u],!0,void 0,c));return new class{listen(u,s,E){let l=x.get(s);if(l)return l;let e=p[s];if(typeof e=="function"){if(i(s))return e.call(p,E);if(n(s))return x.set(s,y.buffer(p[s],!0,void 0,c)),x.get(s)}throw new Error(`Event not found: ${s}`)}call(u,s,E){let l=p[s];if(typeof l=="function"){if(!I&&Array.isArray(E))for(let f=0;f<E.length;f++)E[f]=N(E[f]);let e=l.apply(p,E);return e instanceof Promise||(e=Promise.resolve(e)),e}throw new Error(`Method not found: ${s}`)}}}b.fromService=t;function r(_,c){return new Proxy({},{get(m,p){if(typeof p=="string")return c?.properties?.has(p)?c.properties.get(p):async function(...I){return await _.call(p,I)};throw new Error(`Property not found: ${String(p)}`)}})}b.toService=r})(Q||={});export{L as Disposable,g as DisposableStore,Q as ProxyChannel,G as combinedDisposable,k as dispose,N as revive,B as toDisposable};
