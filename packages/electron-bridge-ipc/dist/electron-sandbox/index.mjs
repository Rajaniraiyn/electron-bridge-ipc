var A=class{_isDisposed=!1;_toDispose=new Set;dispose(){this._isDisposed||(this._isDisposed=!0,this.clear())}clear(){if(this._toDispose.size!==0)try{N(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}},k=class{_store=new A;static None=Object.freeze({dispose(){}});dispose(){this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};function N(t){if(t&&Symbol.iterator in t){let e=[];for(let n of t)if(n)try{n.dispose()}catch(i){e.push(i)}if(e.length===1)throw e[0];if(e.length>1)throw new Error("Encountered errors while disposing of store");return Array.isArray(t)?[]:t}else if(t&&"dispose"in t)return t.dispose(),t}function d(...t){return w(()=>N(t))}function w(t){return{dispose:t}}var ie=0,M=class{constructor(e){this.value=e}stack;id=ie++},V=class{i=-1;end=0;current;value;enqueue(e,n,i){this.i=0,this.end=i,this.current=e,this.value=n}reset(){this.i=this.end,this.current=void 0,this.value=void 0}};function se(t,e){return Array.isArray(e)?e.push(t):e&&e.add(t),t}var g=class{_listeners;_deliveryQueue;_disposed;_options;_event;_size=0;constructor(e){this._options=e,this._deliveryQueue=this._options?.deliveryQueue}_deliver(e,n){e&&e.value(n)}_deliverQueue(e){let n=e.current._listeners;for(;e.i<e.end;)this._deliver(n[e.i++],e.value);e.reset()}fire(e){if(this._deliveryQueue?.current&&this._deliverQueue(this._deliveryQueue),this._listeners)if(this._listeners instanceof M)this._deliver(this._listeners,e);else{let n=this._deliveryQueue;n.enqueue(this,e,this._listeners.length),this._deliverQueue(n)}}get event(){return this._event=(e,n,i)=>{if(this._disposed)return k.None;n&&(e=e.bind(n));let s=new M(e);this._listeners?this._listeners instanceof M?(this._deliveryQueue??=new V,this._listeners=[this._listeners,s]):this._listeners.push(s):(this._options?.onWillAddFirstListener?.(this),this._listeners=s,this._options?.onDidAddFirstListener?.(this)),this._size++;let o=w(()=>{this._removeListener(s)});return i instanceof A?i.add(o):Array.isArray(i)&&i.push(o),o},this._event}_removeListener(e){if(this._options?.onWillRemoveListener?.(this),!this._listeners)return;if(this._size===1){this._listeners=void 0,this._options?.onDidRemoveLastListener?.(this),this._size=0;return}let n=this._listeners,i=n.indexOf(e);if(i===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,n[i]=void 0;let s=this._deliveryQueue.current===this,o=0;for(let r=0;r<n.length;r++)n[r]?n[o++]=n[r]:s&&(this._deliveryQueue.end--,o<this._deliveryQueue.i&&this._deliveryQueue.i--);n.length=o}dispose(){this._disposed||(this._disposed=!0,this._deliveryQueue?.current===this&&this._deliveryQueue.reset(),this._listeners&&(this._listeners=void 0,this._size=0),this._options?.onDidRemoveLastListener?.())}};var R;(v=>{function t(c,_=!1,p=[],u){let l=p.slice(),f=c(U=>{l?l.push(U):b.fire(U)});u&&u.add(f);let E=()=>{l?.forEach(U=>b.fire(U)),l=null},b=new g({onWillAddFirstListener(){f||(f=c(U=>b.fire(U)),u&&u.add(f))},onDidAddFirstListener(){l&&(_?setTimeout(E):E())},onDidRemoveLastListener(){f&&f.dispose(),f=null}});return u&&u.add(b),b.event}v.buffer=t,v.None=()=>k.None;function n(c,_){let p,u={onWillAddFirstListener(){p=c(l.fire,l)},onDidRemoveLastListener(){p?.dispose()}},l=new g(u);return _?.add(l),l.event}function i(c){return c}v.signal=i;function s(c,_,p){return n((u,l=null,f)=>c(E=>_(E)&&u.call(l,E),null,f),p)}v.filter=s;function o(...c){return(_,p=null,u)=>{let l=d(...c.map(f=>f(E=>_.call(p,E))));return se(l,u)}}v.any=o;function r(c,_,p){return n((u,l=null,f)=>c(E=>u.call(l,_(E)),null,f),p)}v.map=r;function a(c){return(_,p=null,u)=>{let l=!1,f=c(E=>{if(!l)return f?f.dispose():l=!0,_.call(p,E)},null,u);return l&&f.dispose(),f}}v.once=a;function m(c){return new Promise(_=>a(c)(_))}v.toPromise=m;function D(c,_,p=u=>u){let u=(...b)=>E.fire(p(...b)),l=()=>c.on(_,u),f=()=>c.removeListener(_,u),E=new g({onWillAddFirstListener:l,onDidRemoveLastListener:f});return E.event}v.fromNodeEventEmitter=D})(R||={});var q=typeof Buffer<"u",T=class t{buffer;byteLength;constructor(e){this.buffer=e,this.byteLength=this.buffer.byteLength}static wrap(e){return q&&!Buffer.isBuffer(e)&&(e=Buffer.from(e.buffer,e.byteOffset,e.byteLength)),new t(e)}writeUInt8(e,n){re(this.buffer,e,n)}readUInt8(e){return le(this.buffer,e)}static alloc(e){return q?new t(Buffer.allocUnsafe(e)):new t(new Uint8Array(e))}static concat(e,n){if(typeof n>"u"){n=0;for(let o=0,r=e.length;o<r;o++)n+=e[o].byteLength}let i=t.alloc(n),s=0;for(let o=0,r=e.length;o<r;o++){let a=e[o];i.set(a,s),s+=a.byteLength}return i}set(e,n){if(e instanceof t)this.buffer.set(e.buffer,n);else if(e instanceof Uint8Array)this.buffer.set(e,n);else if(e instanceof ArrayBuffer)this.buffer.set(new Uint8Array(e),n);else if(ArrayBuffer.isView(e))this.buffer.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n);else throw new TypeError("Unknown argument 'array'")}slice(e,n){return new t(this.buffer.subarray(e,n))}static fromString(e,n){return!(n?.dontUseNodeBuffer||!1)&&q?new t(Buffer.from(e)):(j||(j=new TextEncoder),new t(j.encode(e)))}toString(){return q?this.buffer.toString():(X||(X=new TextDecoder),X.decode(this.buffer))}},j,X;var I={Undefined:x(0),String:x(1),Buffer:x(2),ELBuffer:x(3),Array:x(4),Object:x(5),Uint:x(6)};function x(t){let e=T.alloc(1);return e.writeUInt8(t,0),e}var oe=x(0);function B(t,e){if(e===0){t.write(oe);return}let n=0;for(let s=e;s!==0;s=s>>>7)n++;let i=T.alloc(n);for(let s=0;e!==0;s++)i.buffer[s]=e&127,e=e>>>7,e>0&&(i.buffer[s]|=128);t.write(i)}function O(t){let e=0;for(let n=0;;n+=7){let i=t.read(1);if(e|=(i.buffer[0]&127)<<n,!(i.buffer[0]&128))return e}}function re(t,e,n){t[n]=e}function le(t,e){return t[e]}var G=class{constructor(e){this.buffer=e}pos=0;read(e){let n=this.buffer.slice(this.pos,this.pos+e);return this.pos+=n.byteLength,n}},P=class{buffers=[];get buffer(){return T.concat(this.buffers)}write(e){this.buffers.push(e)}};function L(t,e){if(typeof e>"u")t.write(I.Undefined);else if(typeof e=="string"){let n=T.fromString(e);t.write(I.String),B(t,n.byteLength),t.write(n)}else if(q&&Buffer.isBuffer(e)){let n=T.wrap(e);t.write(I.Buffer),B(t,n.byteLength),t.write(n)}else if(e instanceof T)t.write(I.ELBuffer),B(t,e.byteLength),t.write(e);else if(Array.isArray(e)){t.write(I.Array),B(t,e.length);for(let n of e)L(t,n)}else if(typeof e=="number"&&(e|0)===e)t.write(I.Uint),B(t,e);else{let n=T.fromString(JSON.stringify(e));t.write(I.Object),B(t,n.byteLength),t.write(n)}}function S(t){switch(t.read(1).readUInt8(0)){case 0:return;case 1:return t.read(O(t)).toString();case 2:return t.read(O(t)).buffer;case 3:return t.read(O(t));case 4:{let n=O(t),i=[];for(let s=0;s<n;s++)i.push(S(t));return i}case 5:return JSON.parse(t.read(O(t)).toString());case 6:return O(t)}}function ee(t){return t>=65&&t<=90}function Y(t,e=0){if(!t||e>200)return t;if(typeof t=="object"){switch(t.$mid){case 2:return new RegExp(t.source,t.flags);case 17:return new Date(t.source)}if(t instanceof T||t instanceof Uint8Array)return t;if(Array.isArray(t))for(let n=0;n<t.length;++n)t[n]=Y(t[n],e+1);else for(let n in t)Object.hasOwnProperty.call(t,n)&&(t[n]=Y(t[n],e+1))}return t}var J;(s=>{function t(o){return o.startsWith("onDynamic")&&ee(o.charCodeAt(9))}function e(o){return o[0]==="o"&&o[1]==="n"&&ee(o.charCodeAt(2))}function n(o,r,a){let m=o,D=a&&a.disableMarshalling,v=new Map;for(let c in m)e(c)&&v.set(c,R.buffer(m[c],!0,void 0,r));return new class{listen(c,_,p){let u=v.get(_);if(u)return u;let l=m[_];if(typeof l=="function"){if(t(_))return l.call(m,p);if(e(_))return v.set(_,R.buffer(m[_],!0,void 0,r)),v.get(_)}throw new Error(`Event not found: ${_}`)}call(c,_,p){let u=m[_];if(typeof u=="function"){if(!D&&Array.isArray(p))for(let f=0;f<p.length;f++)p[f]=Y(p[f]);let l=u.apply(m,p);return l instanceof Promise||(l=Promise.resolve(l)),l}throw new Error(`Method not found: ${_}`)}}}s.fromService=n;function i(o,r){return new Proxy({},{get(a,m){if(typeof m=="string")return r?.properties?.has(m)?r.properties.get(m):async function(...D){return await o.call(m,D)};throw new Error(`Property not found: ${String(m)}`)}})}s.toService=i})(J||={});var _e=globalThis.__el_bridge,F=_e.ipcRenderer;var ne=Object.freeze((t,e)=>{let n=setTimeout(t.bind(e),0);return{dispose(){clearTimeout(n)}}}),H=class{_isCancelled=!1;_emitter=null;cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?ne:(this._emitter||(this._emitter=new g),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=null)}},$=class{_token=void 0;_parentListener=void 0;constructor(e){this._parentListener=e&&e.onCancellationRequested(this.cancel,this)}get token(){return this._token||(this._token=new H),this._token}cancel(){this._token?this._token instanceof H&&this._token.cancel():this._token=z.Cancelled}dispose(e=!1){e&&this.cancel(),this._parentListener?.dispose(),this._token?this._token instanceof H&&this._token.dispose():this._token=z.None}},y=class extends Error{constructor(){super("Canceled"),this.name=this.message}};function Z(t){let e=new $,n=t(e.token),i=new Promise((s,o)=>{let r=e.token.onCancellationRequested(()=>{r.dispose(),o(new y)});Promise.resolve(n).then(a=>{r.dispose(),e.dispose(),s(a)},a=>{r.dispose(),e.dispose(),o(a)})});return new class{cancel(){e.cancel(),e.dispose()}then(s,o){return i.then(s,o)}catch(s){return this.then(void 0,s)}finally(s){return i.finally(s)}}}var z;(i=>{function t(s){return s===i.None||s===i.Cancelled?!0:!s||typeof s!="object"?!1:typeof s.isCancellationRequested=="boolean"&&typeof s.onCancellationRequested=="function"}i.isCancellationToken=t,i.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:R.None}),i.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:ne})})(z||={});var h=class{constructor(e){this.protocol=e;this.protocolListener=this.protocol.onMessage(n=>this.onBuffer(n))}protocolListener;state=0;activeRequests=new Set;lastRequestId=0;handlers=new Map;_onDidInitialize=new g;isDisposed=!1;onDidInitialize=this._onDidInitialize.event;getChannel(e){let n=this;return{call(i,s,o){return n.isDisposed?Promise.reject(new y):n.requestPromise(e,i,s,o)},listen(i,s){return n.isDisposed?R.None:n.requestEvent(e,i,s)}}}requestEvent(e,n,i){let s=this.lastRequestId++,r={id:s,type:102,channelName:e,name:n,arg:i},a=null,m=new g({onWillAddFirstListener:()=>{a=Z(v=>this.whenInitialized()),a.then(()=>{a=null,this.activeRequests.add(m),this.sendRequest(r)})},onDidRemoveLastListener:()=>{a?(a.cancel(),a=null):(this.activeRequests.delete(m),this.sendRequest({id:s,type:103}))}}),D=v=>m.fire(v.data);return this.handlers.set(s,D),m.event}get onDidInitializePromise(){return R.toPromise(this.onDidInitialize)}whenInitialized(){return this.state===1?Promise.resolve():this.onDidInitializePromise}requestPromise(e,n,i,s=z.None){let o=this.lastRequestId++,a={id:o,type:100,channelName:e,name:n,arg:i};if(s.isCancellationRequested)return Promise.reject(new y);let m;return new Promise((v,c)=>{if(s.isCancellationRequested)return c(new y);let _=()=>{let f=E=>{switch(E.type){case 201:this.handlers.delete(o),v(E.data);break;case 202:{this.handlers.delete(o);let b=new Error(E.data.message);b.stack=Array.isArray(E.data.stack)?E.data.stack.join(`
`):E.data.stack,b.name=E.data.name,c(b);break}case 203:this.handlers.delete(o),c(E.data);break}};this.handlers.set(o,f),this.sendRequest(a)},p=null;this.state===1?_():(p=Z(f=>this.whenInitialized()),p.then(()=>{p=null,_()}));let u=()=>{p?(p.cancel(),p=null):this.sendRequest({id:o,type:101}),c(new y)},l=s.onCancellationRequested(u);m=d(w(u),l),this.activeRequests.add(m)}).finally(()=>{m.dispose(),this.activeRequests.delete(m)})}sendRequest(e){switch(e.type){case 100:case 102:{this.send([e.type,e.id,e.channelName,e.name],e.arg);return}case 101:case 103:this.send([e.type,e.id])}}send(e,n=void 0){let i=new P;return L(i,e),L(i,n),this.sendBuffer(i.buffer)}sendBuffer(e){try{return this.protocol.send(e),e.byteLength}catch{return 0}}onBuffer(e){let n=new G(e),i=S(n),s=S(n);switch(i[0]){case 200:return this.onResponse({type:i[0]});case 201:case 202:case 204:case 203:this.onResponse({type:i[0],id:i[1],data:s})}}onResponse(e){if(e.type===200){this.state=1,this._onDidInitialize.fire();return}this.handlers.get(e.id)?.(e)}dispose(){this.isDisposed=!0,this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),N(this.activeRequests.values()),this.activeRequests.clear()}};var C=class{constructor(e,n){this.protocol=e;this.ctx=n;this.protocolListener=this.protocol.onMessage(i=>this.onRawMessage(i)),this.sendResponse({type:200})}channels=new Map;protocolListener;activeRequests=new Map;onRawMessage(e){let n=new G(e),i=S(n),s=S(n);switch(i[0]){case 100:return this.onPromise({type:100,id:i[1],channelName:i[2],name:i[3],arg:s})}}onPromise(e){let n=this.channels.get(e.channelName);if(!n)return;let i;try{i=n.call(this.ctx,e.name,e.arg)}catch(r){i=Promise.reject(r)}let s=e.id;i.then(r=>{this.sendResponse({id:s,data:r,type:201})},r=>{r instanceof Error?this.sendResponse({id:s,data:{message:r.message,name:r.name,stack:r.stack?r.stack.split(`
`):void 0},type:202}):this.sendResponse({id:s,data:r,type:203})}).finally(()=>{this.activeRequests.delete(e.id)});let o=w(()=>{});this.activeRequests.set(e.id,o)}sendResponse(e){switch(e.type){case 200:{let n=this.send([e.type]);return}case 201:case 202:case 204:case 203:{let n=this.send([e.type,e.id],e.data)}}}send(e,n=void 0){let i=new P;return L(i,e),L(i,n),this.sendBuffer(i.buffer)}sendBuffer(e){try{return this.protocol.send(e),e.byteLength}catch{return 0}}registerChannel(e,n){this.channels.set(e,n)}dispose(){this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),N(this.activeRequests.values()),this.activeRequests.clear()}};var W=class{channelClient;channelServer;constructor(e,n){let i=new P;L(i,n),e.send(i.buffer),this.channelClient=new h(e),this.channelServer=new C(e,n)}getChannels(){}getChannel(e){return this.channelClient.getChannel(e)}registerChannel(e,n){this.channelServer.registerChannel(e,n)}dispose(){this.channelClient.dispose(),this.channelServer.dispose()}};var K=class{constructor(e,n){this.sender=e;this.onMessage=n}send(e){try{this.sender.send("_ipc:message",e.buffer)}catch{}}disconnect(){this.sender.send("_ipc:disconnect",null)}};var Q=class t extends W{protocol;static createProtocol(){let e=R.fromNodeEventEmitter(F,"_ipc:message",(n,i)=>T.wrap(i));return F.send("_ipc:hello"),new K(F,e)}constructor(e){let n=t.createProtocol();super(n,e),this.protocol=n}dispose(){this.protocol.disconnect(),super.dispose()}};var te;async function Qe(){let t=await F.invoke("_ipc:get-context");return te=new Q(t.windowId)}function Ve(t){return J.toService(te.getChannel(t))}export{Qe as createClient,Ve as useService};
