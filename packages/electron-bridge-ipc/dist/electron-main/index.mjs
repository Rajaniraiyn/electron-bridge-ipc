import{BrowserWindow as fe,contextBridge as he,ipcMain as ve,ipcRenderer as F}from"electron";import{ipcMain as re}from"electron";var R=class{_isDisposed=!1;_toDispose=new Set;dispose(){this._isDisposed||(this._isDisposed=!0,this.clear())}clear(){if(this._toDispose.size!==0)try{A(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}},_=class{_store=new R;static None=Object.freeze({dispose(){}});dispose(){this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};function A(t){if(t&&Symbol.iterator in t){let e=[];for(let n of t)if(n)try{n.dispose()}catch(s){e.push(s)}if(e.length===1)throw e[0];if(e.length>1)throw new Error("Encountered errors while disposing of store");return Array.isArray(t)?[]:t}else if(t&&"dispose"in t)return t.dispose(),t}function Q(...t){return g(()=>A(t))}function g(t){return{dispose:t}}var oe=0,q=class{constructor(e){this.value=e}stack;id=oe++},Z=class{i=-1;end=0;current;value;enqueue(e,n,s){this.i=0,this.end=s,this.current=e,this.value=n}reset(){this.i=this.end,this.current=void 0,this.value=void 0}};function ae(t,e){return Array.isArray(e)?e.push(t):e&&e.add(t),t}function le(t,e){let n=this,s=!1,i;return function(){if(s)return i;if(s=!0,e)try{i=t.apply(n,arguments)}finally{e()}else i=t.apply(n,arguments);return i}}var y=class{_listeners;_deliveryQueue;_disposed;_options;_event;_size=0;constructor(e){this._options=e,this._deliveryQueue=this._options?.deliveryQueue}_deliver(e,n){e&&e.value(n)}_deliverQueue(e){let n=e.current._listeners;for(;e.i<e.end;)this._deliver(n[e.i++],e.value);e.reset()}fire(e){if(this._deliveryQueue?.current&&this._deliverQueue(this._deliveryQueue),this._listeners)if(this._listeners instanceof q)this._deliver(this._listeners,e);else{let n=this._deliveryQueue;n.enqueue(this,e,this._listeners.length),this._deliverQueue(n)}}get event(){return this._event=(e,n,s)=>{if(this._disposed)return _.None;n&&(e=e.bind(n));let i=new q(e);this._listeners?this._listeners instanceof q?(this._deliveryQueue??=new Z,this._listeners=[this._listeners,i]):this._listeners.push(i):(this._options?.onWillAddFirstListener?.(this),this._listeners=i,this._options?.onDidAddFirstListener?.(this)),this._size++;let r=g(()=>{this._removeListener(i)});return s instanceof R?s.add(r):Array.isArray(s)&&s.push(r),r},this._event}_removeListener(e){if(this._options?.onWillRemoveListener?.(this),!this._listeners)return;if(this._size===1){this._listeners=void 0,this._options?.onDidRemoveLastListener?.(this),this._size=0;return}let n=this._listeners,s=n.indexOf(e);if(s===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,n[s]=void 0;let i=this._deliveryQueue.current===this,r=0;for(let o=0;o<n.length;o++)n[o]?n[r++]=n[o]:i&&(this._deliveryQueue.end--,r<this._deliveryQueue.i&&this._deliveryQueue.i--);n.length=r}dispose(){this._disposed||(this._disposed=!0,this._deliveryQueue?.current===this&&this._deliveryQueue.reset(),this._listeners&&(this._listeners=void 0,this._size=0),this._options?.onDidRemoveLastListener?.())}},j=class{listening=!1;inputEvent=m.None;inputEventListener=_.None;emitter=new y({onDidAddFirstListener:()=>{this.listening=!0,this.inputEventListener=this.inputEvent(this.emitter.fire,this.emitter)},onDidRemoveLastListener:()=>{this.listening=!1,this.inputEventListener.dispose()}});event=this.emitter.event;set input(e){this.inputEvent=e,this.listening&&(this.inputEventListener.dispose(),this.inputEventListener=e(this.emitter.fire,this.emitter))}dispose(){this.inputEventListener.dispose(),this.emitter.dispose()}},W=class{emitter;hasListeners=!1;events=[];constructor(){this.emitter=new y({onWillAddFirstListener:()=>this.onFirstListenerAdd(),onDidRemoveLastListener:()=>this.onLastListenerRemove()})}get event(){return this.emitter.event}add(e){let n={event:e,listener:null};return this.events.push(n),this.hasListeners&&this.hook(n),g(le(()=>{this.hasListeners&&this.unhook(n);let i=this.events.indexOf(n);this.events.splice(i,1)}))}onFirstListenerAdd(){this.hasListeners=!0,this.events.forEach(e=>this.hook(e))}onLastListenerRemove(){this.hasListeners=!1,this.events.forEach(e=>this.unhook(e))}hook(e){e.listener=e.event(n=>this.emitter.fire(n))}unhook(e){e.listener?.dispose(),e.listener=null}dispose(){this.emitter.dispose();for(let e of this.events)e.listener?.dispose();this.events=[]}},m;(b=>{function t(l,c=!1,p=[],d){let u=p.slice(),f=l(L=>{u?u.push(L):C.fire(L)});d&&d.add(f);let h=()=>{u?.forEach(L=>C.fire(L)),u=null},C=new y({onWillAddFirstListener(){f||(f=l(L=>C.fire(L)),d&&d.add(f))},onDidAddFirstListener(){u&&(c?setTimeout(h):h())},onDidRemoveLastListener(){f&&f.dispose(),f=null}});return d&&d.add(C),C.event}b.buffer=t,b.None=()=>_.None;function n(l,c){let p,d={onWillAddFirstListener(){p=l(u.fire,u)},onDidRemoveLastListener(){p?.dispose()}},u=new y(d);return c?.add(u),u.event}function s(l){return l}b.signal=s;function i(l,c,p){return n((d,u=null,f)=>l(h=>c(h)&&d.call(u,h),null,f),p)}b.filter=i;function r(...l){return(c,p=null,d)=>{let u=Q(...l.map(f=>f(h=>c.call(p,h))));return ae(u,d)}}b.any=r;function o(l,c,p){return n((d,u=null,f)=>l(h=>d.call(u,c(h)),null,f),p)}b.map=o;function a(l){return(c,p=null,d)=>{let u=!1,f=l(h=>{if(!u)return f?f.dispose():u=!0,c.call(p,h)},null,d);return u&&f.dispose(),f}}b.once=a;function v(l){return new Promise(c=>a(l)(c))}b.toPromise=v;function T(l,c,p=d=>d){let d=(...C)=>h.fire(p(...C)),u=()=>l.on(c,d),f=()=>l.removeListener(c,d),h=new y({onWillAddFirstListener:u,onDidRemoveLastListener:f});return h.event}b.fromNodeEventEmitter=T})(m||={});var te=Object.freeze((t,e)=>{let n=setTimeout(t.bind(e),0);return{dispose(){clearTimeout(n)}}}),z=class{_isCancelled=!1;_emitter=null;cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?te:(this._emitter||(this._emitter=new y),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=null)}},$=class{_token=void 0;_parentListener=void 0;constructor(e){this._parentListener=e&&e.onCancellationRequested(this.cancel,this)}get token(){return this._token||(this._token=new z),this._token}cancel(){this._token?this._token instanceof z&&this._token.cancel():this._token=U.Cancelled}dispose(e=!1){e&&this.cancel(),this._parentListener?.dispose(),this._token?this._token instanceof z&&this._token.dispose():this._token=U.None}},I=class extends Error{constructor(){super("Canceled"),this.name=this.message}};function G(t){let e=new $,n=t(e.token),s=new Promise((i,r)=>{let o=e.token.onCancellationRequested(()=>{o.dispose(),r(new I)});Promise.resolve(n).then(a=>{o.dispose(),e.dispose(),i(a)},a=>{o.dispose(),e.dispose(),r(a)})});return new class{cancel(){e.cancel(),e.dispose()}then(i,r){return s.then(i,r)}catch(i){return this.then(void 0,i)}finally(i){return s.finally(i)}}}var U;(s=>{function t(i){return i===s.None||i===s.Cancelled?!0:!i||typeof i!="object"?!1:typeof i.isCancellationRequested=="boolean"&&typeof i.onCancellationRequested=="function"}s.isCancellationToken=t,s.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:m.None}),s.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:te})})(U||={});var M=typeof Buffer<"u",E=class t{buffer;byteLength;constructor(e){this.buffer=e,this.byteLength=this.buffer.byteLength}static wrap(e){return M&&!Buffer.isBuffer(e)&&(e=Buffer.from(e.buffer,e.byteOffset,e.byteLength)),new t(e)}writeUInt8(e,n){de(this.buffer,e,n)}readUInt8(e){return ue(this.buffer,e)}static alloc(e){return M?new t(Buffer.allocUnsafe(e)):new t(new Uint8Array(e))}static concat(e,n){if(typeof n>"u"){n=0;for(let r=0,o=e.length;r<o;r++)n+=e[r].byteLength}let s=t.alloc(n),i=0;for(let r=0,o=e.length;r<o;r++){let a=e[r];s.set(a,i),i+=a.byteLength}return s}set(e,n){if(e instanceof t)this.buffer.set(e.buffer,n);else if(e instanceof Uint8Array)this.buffer.set(e,n);else if(e instanceof ArrayBuffer)this.buffer.set(new Uint8Array(e),n);else if(ArrayBuffer.isView(e))this.buffer.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n);else throw new TypeError("Unknown argument 'array'")}slice(e,n){return new t(this.buffer.subarray(e,n))}static fromString(e,n){return!(n?.dontUseNodeBuffer||!1)&&M?new t(Buffer.from(e)):(K||(K=new TextEncoder),new t(K.encode(e)))}toString(){return M?this.buffer.toString():(X||(X=new TextDecoder),X.decode(this.buffer))}},K,X;var x={Undefined:w(0),String:w(1),Buffer:w(2),ELBuffer:w(3),Array:w(4),Object:w(5),Uint:w(6)};function w(t){let e=E.alloc(1);return e.writeUInt8(t,0),e}var ce=w(0);function P(t,e){if(e===0){t.write(ce);return}let n=0;for(let i=e;i!==0;i=i>>>7)n++;let s=E.alloc(n);for(let i=0;e!==0;i++)s.buffer[i]=e&127,e=e>>>7,e>0&&(s.buffer[i]|=128);t.write(s)}function B(t){let e=0;for(let n=0;;n+=7){let s=t.read(1);if(e|=(s.buffer[0]&127)<<n,!(s.buffer[0]&128))return e}}function de(t,e,n){t[n]=e}function ue(t,e){return t[e]}var k=class{constructor(e){this.buffer=e}pos=0;read(e){let n=this.buffer.slice(this.pos,this.pos+e);return this.pos+=n.byteLength,n}},O=class{buffers=[];get buffer(){return E.concat(this.buffers)}write(e){this.buffers.push(e)}};function S(t,e){if(typeof e>"u")t.write(x.Undefined);else if(typeof e=="string"){let n=E.fromString(e);t.write(x.String),P(t,n.byteLength),t.write(n)}else if(M&&Buffer.isBuffer(e)){let n=E.wrap(e);t.write(x.Buffer),P(t,n.byteLength),t.write(n)}else if(e instanceof E)t.write(x.ELBuffer),P(t,e.byteLength),t.write(e);else if(Array.isArray(e)){t.write(x.Array),P(t,e.length);for(let n of e)S(t,n)}else if(typeof e=="number"&&(e|0)===e)t.write(x.Uint),P(t,e);else{let n=E.fromString(JSON.stringify(e));t.write(x.Object),P(t,n.byteLength),t.write(n)}}function D(t){switch(t.read(1).readUInt8(0)){case 0:return;case 1:return t.read(B(t)).toString();case 2:return t.read(B(t)).buffer;case 3:return t.read(B(t));case 4:{let n=B(t),s=[];for(let i=0;i<n;i++)s.push(D(t));return s}case 5:return JSON.parse(t.read(B(t)).toString());case 6:return B(t)}}function Y(t){return typeof t=="function"}var ee=class{constructor(e){this.protocol=e;this.protocolListener=this.protocol.onMessage(n=>this.onBuffer(n))}protocolListener;state=0;activeRequests=new Set;lastRequestId=0;handlers=new Map;_onDidInitialize=new y;isDisposed=!1;onDidInitialize=this._onDidInitialize.event;getChannel(e){let n=this;return{call(s,i,r){return n.isDisposed?Promise.reject(new I):n.requestPromise(e,s,i,r)},listen(s,i){return n.isDisposed?m.None:n.requestEvent(e,s,i)}}}requestEvent(e,n,s){let i=this.lastRequestId++,o={id:i,type:102,channelName:e,name:n,arg:s},a=null,v=new y({onWillAddFirstListener:()=>{a=G(b=>this.whenInitialized()),a.then(()=>{a=null,this.activeRequests.add(v),this.sendRequest(o)})},onDidRemoveLastListener:()=>{a?(a.cancel(),a=null):(this.activeRequests.delete(v),this.sendRequest({id:i,type:103}))}}),T=b=>v.fire(b.data);return this.handlers.set(i,T),v.event}get onDidInitializePromise(){return m.toPromise(this.onDidInitialize)}whenInitialized(){return this.state===1?Promise.resolve():this.onDidInitializePromise}requestPromise(e,n,s,i=U.None){let r=this.lastRequestId++,a={id:r,type:100,channelName:e,name:n,arg:s};if(i.isCancellationRequested)return Promise.reject(new I);let v;return new Promise((b,l)=>{if(i.isCancellationRequested)return l(new I);let c=()=>{let f=h=>{switch(h.type){case 201:this.handlers.delete(r),b(h.data);break;case 202:{this.handlers.delete(r);let C=new Error(h.data.message);C.stack=Array.isArray(h.data.stack)?h.data.stack.join(`
`):h.data.stack,C.name=h.data.name,l(C);break}case 203:this.handlers.delete(r),l(h.data);break}};this.handlers.set(r,f),this.sendRequest(a)},p=null;this.state===1?c():(p=G(f=>this.whenInitialized()),p.then(()=>{p=null,c()}));let d=()=>{p?(p.cancel(),p=null):this.sendRequest({id:r,type:101}),l(new I)},u=i.onCancellationRequested(d);v=Q(g(d),u),this.activeRequests.add(v)}).finally(()=>{v.dispose(),this.activeRequests.delete(v)})}sendRequest(e){switch(e.type){case 100:case 102:{this.send([e.type,e.id,e.channelName,e.name],e.arg);return}case 101:case 103:this.send([e.type,e.id])}}send(e,n=void 0){let s=new O;return S(s,e),S(s,n),this.sendBuffer(s.buffer)}sendBuffer(e){try{return this.protocol.send(e),e.byteLength}catch{return 0}}onBuffer(e){let n=new k(e),s=D(n),i=D(n);switch(s[0]){case 200:return this.onResponse({type:s[0]});case 201:case 202:case 204:case 203:this.onResponse({type:s[0],id:s[1],data:i})}}onResponse(e){if(e.type===200){this.state=1,this._onDidInitialize.fire();return}this.handlers.get(e.id)?.(e)}dispose(){this.isDisposed=!0,this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),A(this.activeRequests.values()),this.activeRequests.clear()}};function pe(t){return t[Math.floor(Math.random()*t.length)]}var ne=class{constructor(e,n){this.protocol=e;this.ctx=n;this.protocolListener=this.protocol.onMessage(s=>this.onRawMessage(s)),this.sendResponse({type:200})}channels=new Map;protocolListener;activeRequests=new Map;onRawMessage(e){let n=new k(e),s=D(n),i=D(n);switch(s[0]){case 100:return this.onPromise({type:100,id:s[1],channelName:s[2],name:s[3],arg:i})}}onPromise(e){let n=this.channels.get(e.channelName);if(!n)return;let s;try{s=n.call(this.ctx,e.name,e.arg)}catch(o){s=Promise.reject(o)}let i=e.id;s.then(o=>{this.sendResponse({id:i,data:o,type:201})},o=>{o instanceof Error?this.sendResponse({id:i,data:{message:o.message,name:o.name,stack:o.stack?o.stack.split(`
`):void 0},type:202}):this.sendResponse({id:i,data:o,type:203})}).finally(()=>{this.activeRequests.delete(e.id)});let r=g(()=>{});this.activeRequests.set(e.id,r)}sendResponse(e){switch(e.type){case 200:{let n=this.send([e.type]);return}case 201:case 202:case 204:case 203:{let n=this.send([e.type,e.id],e.data)}}}send(e,n=void 0){let s=new O;return S(s,e),S(s,n),this.sendBuffer(s.buffer)}sendBuffer(e){try{return this.protocol.send(e),e.byteLength}catch{return 0}}registerChannel(e,n){this.channels.set(e,n)}dispose(){this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),A(this.activeRequests.values()),this.activeRequests.clear()}};function se(t){return{call(e,n,s){return t.then(i=>i.call(e,n,s))},listen(e,n){let s=new j;return t.then(i=>s.input=i.listen(e,n)),s.event}}}var H=class{channels=new Map;_connections=new Set;_onDidAddConnection=new y;onDidAddConnection=this._onDidAddConnection.event;_onDidRemoveConnection=new y;onDidRemoveConnection=this._onDidRemoveConnection.event;disposables=new R;get connections(){let e=[];return this._connections.forEach(n=>e.push(n)),e}constructor(e){this.disposables.add(e(({protocol:n,onDidClientDisconnect:s})=>{let i=m.once(n.onMessage);this.disposables.add(i(r=>{let o=new k(r),a=D(o),v=new ne(n,a),T=new ee(n);this.channels.forEach((l,c)=>v.registerChannel(c,l));let b={channelServer:v,channelClient:T,ctx:a};this._connections.add(b),this._onDidAddConnection.fire(b),this.disposables.add(s(()=>{v.dispose(),T.dispose(),this._connections.delete(b),this._onDidRemoveConnection.fire(b)}))}))}))}getChannel(e,n){let s=this;return{call(i,r,o){let a;if(Y(n)){let T=pe(s.connections.filter(n));a=T?Promise.resolve(T):m.toPromise(m.filter(s.onDidAddConnection,n))}else a=n.routeCall(s,i,r);let v=a.then(T=>T.channelClient.getChannel(e));return se(v).call(i,r,o)},listen(i,r){if(Y(n))return s.getMulticastEvent(e,n,i,r);let o=n.routeEvent(s,i,r).then(a=>a.channelClient.getChannel(e));return se(o).listen(i,r)}}}getMulticastEvent(e,n,s,i){let r=this,o,a=new y({onWillAddFirstListener:()=>{o=new R;let v=new W,T=new Map,b=c=>{let d=c.channelClient.getChannel(e).listen(s,i),u=v.add(d);T.set(c,u)},l=c=>{let p=T.get(c);p&&(p.dispose(),T.delete(c))};r.connections.filter(n).forEach(b),m.filter(r.onDidAddConnection,n)(b,void 0,o),r.onDidRemoveConnection(l,void 0,o),v.event(a.fire,a,o),o.add(v)},onDidRemoveLastListener:()=>{o?.dispose(),o=void 0}});return a.event}registerChannel(e,n){this.channels.set(e,n);for(let s of this._connections)s.channelServer.registerChannel(e,n)}dispose(){this.disposables.dispose();for(let e of this._connections)e.channelClient.dispose(),e.channelServer.dispose();this._connections.clear(),this.channels.clear(),this._onDidAddConnection.dispose(),this._onDidRemoveConnection.dispose()}};var V=class{constructor(e,n){this.sender=e;this.onMessage=n}send(e){try{this.sender.send("_ipc:message",e.buffer)}catch{}}disconnect(){this.sender.send("_ipc:disconnect",null)}};function ie(t,e){let n=m.fromNodeEventEmitter(re,e,(i,r)=>({event:i,message:r})),s=m.filter(n,({event:i})=>i.sender.id===t);return m.map(s,({message:i})=>i&&E.wrap(i))}var J=class t extends H{static Clients=new Map;static getOnDidClientConnect(){let e=m.fromNodeEventEmitter(re,"_ipc:hello",({sender:n})=>n);return m.map(e,n=>{let s=n.id;t.Clients.get(s)?.dispose();let r=new y;t.Clients.set(s,g(()=>r.fire()));let o=ie(s,"_ipc:message"),a=m.any(m.signal(ie(s,"_ipc:disconnect")),r.event);return{protocol:new V(n,o),onDidClientDisconnect:a}})}constructor(){super(t.getOnDidClientConnect())}};function Fe(){return ve.handle("_ipc:get-context",({sender:t})=>fe.fromId(t.id)?.id),new J}function N(t){if(!t||!t.startsWith("_ipc:"))throw new Error(`Unsupported event IPC channel '${t}'`);return!0}function Ne(){he.exposeInMainWorld("__el_bridge",{ipcRenderer:{send(t,...e){N(t)&&F.send(t,...e)},invoke(t,...e){return N(t),F.invoke(t,...e)},on(t,e){return N(t),F.on(t,e),this},once(t,e){return N(t),F.once(t,e),this},removeListener(t,e){return N(t),F.removeListener(t,e),this}}})}export{Ne as createPreload,Fe as createServer};
